<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ETF Monitor" />
  <meta name="theme-color" content="#080c14" />
  <title>ETF Monitor</title>
  <link rel="apple-touch-icon" href="icon.png" />
  <link rel="manifest" href="manifest.json" />
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&display=swap');
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: #080c14; color: #e2e8f0; font-family: 'DM Mono', monospace; overflow: hidden; }
    #root { height: 100%; display: flex; flex-direction: column; }
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: #080c14; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    @keyframes spin { to{transform:rotate(360deg)} }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .fade-in { animation: fadeIn 0.3s ease both; }
    button { font-family: inherit; cursor: pointer; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const WORKER_URL = "https://kis-proxy.yusunghwan.workers.dev";
const API = WORKER_URL;

// ═══════════════════════════════════════════════════════════════
//  ★ 종목 추가/변경 방법
//
//  아래 ETF_LIST 배열에 항목을 추가하거나 수정하세요.
//  ticker : KRX 종목코드 (6자리 숫자)
//  name   : 화면에 표시할 이름 (자유롭게 입력)
//
//  예시) { ticker: "102110", name: "TIGER 200" },
//       { ticker: "kodex레버리지", name: "KODEX 레버리지" },
//
//  주요 ETF 종목코드 참고:
//  069500  KODEX 200
//  102110  TIGER 200
//  360750  TIGER 미국S&P500
//  133690  TIGER 미국나스닥100
//  114800  KODEX 인버스
//  252670  KODEX 200선물인버스2X
//  229200  KODEX 코스닥150
//  132030  KODEX 골드선물
//  139660  TIGER 미국달러단기채권액티브
//  385560  TIGER 미국채10년선물
// ═══════════════════════════════════════════════════════════════
const ETF_LIST = [
  { ticker: "251350", name: "KODEX MSCI선진국" },
  { ticker: "133690", name: "TIGER 미국나스닥100" },  
  { ticker: "381170", name: "TIGER 미국테크TOP10 INDXX" },
  { ticker: "069500", name: "KODEX 200" },
  { ticker: "292150", name: "TIGER 코리아TOP10" },
  { ticker: "411060", name: "ACE KRX금현물" },
  { ticker: "144600", name: "KODEX 은선물(H)" },
  { ticker: "453850", name: "ACE 미국채30년액티브(H)" },
  { ticker: "385560", name: "TIGER 미국채10년선물" },
  { ticker: "139660", name: "TIGER 미국달러단기채권액티브" },
];

// ── 지표 계산 ─────────────────────────────────────────────────────
const calcEMA = (data, p) => {
  const k = 2/(p+1); const res = []; let prev = null;
  data.forEach((v,i) => {
    if(i < p-1){res.push(null);return;}
    if(prev===null) prev = data.slice(0,p).reduce((s,x)=>s+x,0)/p;
    const cur = v*k+prev*(1-k); res.push(+cur.toFixed(2)); prev=cur;
  });
  return res;
};

const calcRSI = (closes, p=14) => {
  const res = Array(closes.length).fill(null);
  if(closes.length < p+1) return res;
  let g=0,l=0;
  for(let i=1;i<=p;i++){const d=closes[i]-closes[i-1]; if(d>0)g+=d; else l-=d;}
  let ag=g/p, al=l/p;
  res[p] = al===0?100:+(100-100/(1+ag/al)).toFixed(2);
  for(let i=p+1;i<closes.length;i++){
    const d=closes[i]-closes[i-1];
    ag=(ag*(p-1)+Math.max(d,0))/p; al=(al*(p-1)+Math.max(-d,0))/p;
    res[i] = al===0?100:+(100-100/(1+ag/al)).toFixed(2);
  }
  return res;
};

// 일봉/주봉/월봉 변환 (일봉 데이터를 집계)
const groupCandles = (candles, unit) => {
  if(unit === "D") return candles;
  const groups = {};
  candles.forEach(c => {
    let key;
    const d = c.rawDate; // YYYYMMDD
    if(unit === "W") {
      // 해당 날짜가 속한 주의 월요일 기준
      const date = new Date(d.slice(0,4), d.slice(4,6)-1, d.slice(6,8));
      const day = date.getDay();
      const diff = day===0 ? -6 : 1-day;
      date.setDate(date.getDate()+diff);
      key = date.toISOString().slice(0,10).replace(/-/g,"");
    } else {
      key = d.slice(0,6); // YYYYMM
    }
    if(!groups[key]) groups[key] = {rawDate:key, open:c.open, high:c.high, low:c.low, close:c.close, volume:c.volume};
    else {
      groups[key].high = Math.max(groups[key].high, c.high);
      groups[key].low  = Math.min(groups[key].low,  c.low);
      groups[key].close = c.close;
      groups[key].volume += c.volume;
    }
  });
  return Object.values(groups).sort((a,b)=>a.rawDate.localeCompare(b.rawDate));
};

const formatDate = (rawDate, unit) => {
  if(!rawDate) return "";
  const s = String(rawDate);
  if(unit === "D") return `${s.slice(4,6)}/${s.slice(6,8)}`;
  if(unit === "W") return `${s.slice(4,6)}/${s.slice(6,8)}`;
  return `${s.slice(0,4)}/${s.slice(4,6)}`;
};

// 단위별 차트 데이터 (가격/EMA용)
const enrichChart = (candles, unit="D") => {
  const grouped = groupCandles(candles, unit);
  const closes = grouped.map(c=>c.close);
  const ema20=calcEMA(closes,20), ema60=calcEMA(closes,60), rsi=calcRSI(closes,14);
  return grouped.map((c,i)=>({
    ...c,
    date: formatDate(c.rawDate, unit),
    ema20:ema20[i], ema60:ema60[i], rsi:rsi[i],
  }));
};

// 일봉 기준 X축에 일봉/주봉/월봉 RSI를 모두 매핑
const enrichMultiRSI = (candles) => {
  if(!candles.length) return [];

  // 일봉 RSI
  const dailyCloses = candles.map(c=>c.close);
  const dailyRSI = calcRSI(dailyCloses, 14);

  // 주봉 집계 후 RSI → 마지막 날짜에 매핑
  const weekly = groupCandles(candles, "W");
  const weeklyRSI = calcRSI(weekly.map(c=>c.close), 14);
  // 주봉 RSI를 날짜 Map으로 변환 (각 주의 마지막 거래일)
  const weeklyMap = {};
  weekly.forEach((w,i)=>{
    // 해당 주에 속하는 일봉 중 마지막 날을 찾음
    const weekKey = w.rawDate; // 주 시작일(월요일) YYYYMMDD
    const weekStart = parseInt(weekKey);
    // 해당 주에 속하는 candle 중 마지막 rawDate
    const inWeek = candles.filter(c=>{
      const d = new Date(c.rawDate.slice(0,4), c.rawDate.slice(4,6)-1, c.rawDate.slice(6,8));
      const day = d.getDay();
      const diff = day===0?-6:1-day;
      d.setDate(d.getDate()+diff);
      const mondayStr = d.toISOString().slice(0,10).replace(/-/g,"");
      return mondayStr === weekKey;
    });
    if(inWeek.length) weeklyMap[inWeek[inWeek.length-1].rawDate] = weeklyRSI[i];
  });

  // 월봉 집계 후 RSI → 마지막 날짜에 매핑
  const monthly = groupCandles(candles, "M");
  const monthlyRSI = calcRSI(monthly.map(c=>c.close), 14);
  const monthlyMap = {};
  monthly.forEach((m,i)=>{
    const monthKey = m.rawDate.slice(0,6); // YYYYMM
    const inMonth = candles.filter(c=>c.rawDate.slice(0,6)===monthKey);
    if(inMonth.length) monthlyMap[inMonth[inMonth.length-1].rawDate] = monthlyRSI[i];
  });

  return candles.map((c,i)=>({
    date: formatDate(c.rawDate, "D"),
    rsiD: dailyRSI[i],
    rsiW: weeklyMap[c.rawDate] ?? null,
    rsiM: monthlyMap[c.rawDate] ?? null,
  }));
};

// forward fill 적용 — 주봉/월봉 RSI를 다음 값이 나올 때까지 이전 값으로 채움
const forwardFillRSI = (data) => {
  let lastW = null, lastM = null;
  return data.map(d => {
    if(d.rsiW != null) lastW = d.rsiW;
    if(d.rsiM != null) lastM = d.rsiM;
    return { ...d, rsiW: lastW, rsiM: lastM };
  });
};

// ── 컴포넌트 ──────────────────────────────────────────────────────
const { useState, useEffect, useRef, useCallback } = React;
const { LineChart,Line,XAxis,YAxis,CartesianGrid,Tooltip,ResponsiveContainer,ReferenceLine } = Recharts;

const Skel = ({w="100%",h=14}) => (
  <div style={{width:w,height:h,borderRadius:4,background:"#1e293b",animation:"pulse 1.5s infinite"}}/>
);

const RSIMeter = ({value}) => {
  if(value==null) return <span style={{color:"#475569",fontSize:11}}>—</span>;
  const color = value>=70?"#ef4444":value<=30?"#22c55e":"#94a3b8";
  const label = value>=70?"과매수":value<=30?"과매도":"중립";
  return (
    <div style={{width:"100%"}}>
      <div style={{display:"flex",justifyContent:"space-between",fontSize:10,marginBottom:3}}>
        <span style={{color,fontWeight:700}}>{value.toFixed(1)}</span>
        <span style={{color}}>{label}</span>
      </div>
      <div style={{height:4,borderRadius:4,background:"#1e293b",overflow:"hidden"}}>
        <div style={{height:"100%",width:`${value}%`,background:color,borderRadius:4,transition:"width 0.5s"}}/>
      </div>
    </div>
  );
};

const Signal = ({ema20,ema60}) => {
  if(!ema20||!ema60) return null;
  const bull = ema20>ema60;
  return <span style={{fontSize:11,padding:"2px 10px",borderRadius:20,fontWeight:700,background:bull?"#064e3b":"#450a0a",color:bull?"#34d399":"#f87171"}}>{bull?"▲ 골든크로스":"▼ 데드크로스"}</span>;
};

// ── 메인 앱 ──────────────────────────────────────────────────────
function App() {
  const [etfs,setEtfs]           = useState(ETF_LIST.map(e=>({...e,loading:true})));
  const [selected,setSelected]   = useState(ETF_LIST[0].ticker);
  const [rawCandles,setRawCandles] = useState([]); // 원본 일봉 데이터
  const [chartUnit,setChartUnit] = useState("D");  // D/W/M
  const [chartType,setChartType] = useState("price");
  const [chartLoading,setChartLoading] = useState(false);
  const [serverOk,setServerOk]   = useState(null);
  const [lastUpdate,setLastUpdate] = useState(null);
  const [sideOpen,setSideOpen]   = useState(true);


  useEffect(()=>{
    fetch(`${API}/api/health`).then(r=>r.ok?setServerOk(true):setServerOk(false)).catch(()=>setServerOk(false));
  },[]);

  const fetchPrices = useCallback(async()=>{
    const results = await Promise.allSettled(
      ETF_LIST.map(e=>fetch(`${API}/api/price/${e.ticker}`).then(r=>r.json()))
    );
    setEtfs(prev=>prev.map((e,i)=>{
      const r=results[i];
      if(r.status==="fulfilled"&&r.value.price){ const {name:_ignore, ...rest}=r.value; return{...e,...rest, loading:false,error:false}; }
      return{...e,loading:false,error:true};
    }));
    setLastUpdate(new Date());
  },[]);

  const fetchChart = useCallback(async(ticker)=>{
    setChartLoading(true);
    try{
      const r=await fetch(`${API}/api/chart/${ticker}?period=600`);
      const d=await r.json();
      // rawDate 보존
      const candles = (d.candles||[]).map(c=>({...c, rawDate:c.date}));
      setRawCandles(candles);
    }catch{ setRawCandles([]); }
    finally{ setChartLoading(false); }
  },[]);

  useEffect(()=>{
    fetchPrices(); fetchChart(selected);
  },[]);

  useEffect(()=>{ fetchChart(selected); },[selected]);

  const cur = etfs.find(e=>e.ticker===selected)??{};

  // 단위별 차트 데이터 계산
  const chartData = enrichChart(rawCandles, chartUnit);
  const multiRSI = forwardFillRSI(enrichMultiRSI(rawCandles));
  const display = chartData.slice(-60);
  const displayRSI = multiRSI.slice(-60);
  const lastBar = chartData[chartData.length-1];
  const lastRSI = multiRSI[multiRSI.length-1];

  const safeTop = "env(safe-area-inset-top, 0px)";
  const safeBottom = "env(safe-area-inset-bottom, 0px)";

  const unitBtnStyle = (u) => ({
    padding:"4px 12px", borderRadius:6, fontSize:11, fontWeight:600,
    background: chartUnit===u?"#1e3a5f":"transparent",
    border: chartUnit===u?"1px solid #38bdf8":"1px solid #1e293b",
    color: chartUnit===u?"#38bdf8":"#64748b",
  });

  return (
    <div style={{display:"flex",flexDirection:"column",height:"100%",paddingTop:safeTop,paddingBottom:safeBottom}}>

      {/* 헤더 */}
      <div style={{borderBottom:"1px solid #1e293b",padding:"12px 20px",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <button onClick={()=>setSideOpen(o=>!o)} style={{background:"none",border:"none",color:"#64748b",fontSize:18,padding:"0 4px",lineHeight:1}}>☰</button>
          <div style={{width:8,height:8,borderRadius:"50%",background:serverOk===null?"#f59e0b":serverOk?"#22c55e":"#ef4444",boxShadow:`0 0 8px ${serverOk?"#22c55e":"#ef4444"}`,animation:"pulse 2s infinite"}}/>
          <span style={{fontSize:15,fontWeight:700,letterSpacing:"0.1em"}}>ETF MONITOR</span>
          <span style={{fontSize:10,padding:"2px 8px",borderRadius:4,background:serverOk?"#064e3b":"#450a0a",color:serverOk?"#34d399":"#f87171"}}>
            {serverOk===null?"연결 중…":serverOk?"KIS 연결됨":"오프라인"}
          </span>
        </div>
        <div style={{fontSize:11,color:"#475569"}}>
          {lastUpdate?lastUpdate.toLocaleTimeString("ko-KR"):"—"}
        </div>
      </div>

      <div style={{display:"flex",flex:1,overflow:"hidden"}}>

        {/* ── 사이드바 ── */}
        {sideOpen && (
          <div style={{width:220,borderRight:"1px solid #1e293b",overflowY:"auto",flexShrink:0}} className="fade-in">
            {etfs.map(e=>(
              <div key={e.ticker} onClick={()=>setSelected(e.ticker)}
                style={{padding:"12px 14px",cursor:"pointer",
                  borderLeft:selected===e.ticker?"2px solid #38bdf8":"2px solid transparent",
                  background:selected===e.ticker?"#0f172a":"transparent",transition:"all 0.15s"}}>

                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div style={{flex:1,minWidth:0,marginRight:8}}>
                    {/* ★ 1번 수정: 종목명 크게, 코드 작게 */}
                    <div style={{fontWeight:700,fontSize:13,color:selected===e.ticker?"#38bdf8":"#f1f5f9",
                      whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>
                      {e.name}
                    </div>
                    <div style={{fontSize:10,color:"#475569",marginTop:2}}>{e.ticker}</div>
                  </div>
                  <div style={{textAlign:"right",flexShrink:0}}>
                    {e.loading?<Skel w={55} h={12}/>:<>
                      <div style={{fontWeight:700,fontSize:12}}>{e.price?.toLocaleString()??'—'}</div>
                      <div style={{fontSize:11,color:(e.change_pct??0)>=0?"#22c55e":"#ef4444"}}>
                        {(e.change_pct??0)>=0?"+":""}{e.change_pct?.toFixed(2)??"—"}%
                      </div>
                    </>}
                  </div>
                </div>

                {selected===e.ticker&&lastBar?.rsi!=null&&(
                  <div style={{marginTop:8}}><RSIMeter value={lastBar.rsi}/></div>
                )}
              </div>
            ))}
          </div>
        )}

        {/* ── 메인 패널 ── */}
        <div style={{flex:1,overflowY:"auto",padding:20}} className="fade-in">

          {/* 종목 헤더 */}
          <div style={{marginBottom:16}}>
            <div style={{display:"flex",alignItems:"baseline",gap:10,flexWrap:"wrap"}}>
              <span style={{fontSize:20,fontWeight:800,color:"#f8fafc"}}>{cur.name}</span>
              <span style={{fontSize:11,color:"#64748b"}}>{cur.ticker}</span>
              {lastBar&&<Signal ema20={lastBar.ema20} ema60={lastBar.ema60}/>}
            </div>
            <div style={{marginTop:6,fontSize:26,fontWeight:700}}>
              {cur.loading?<Skel w={150} h={26}/>:<>
                {cur.price?.toLocaleString()??'—'}원
                <span style={{fontSize:14,marginLeft:10,color:(cur.change_pct??0)>=0?"#22c55e":"#ef4444"}}>
                  {(cur.change_pct??0)>=0?"+":""}{cur.change?.toLocaleString()??'—'} ({(cur.change_pct??0)>=0?"+":""}{cur.change_pct?.toFixed(2)??"—"}%)
                </span>
              </>}
            </div>
          </div>

          {/* 지표 카드 */}
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8,marginBottom:16}}>
            {[
              {label:"고가",value:cur.high?.toLocaleString(),color:"#22c55e"},
              {label:"저가",value:cur.low?.toLocaleString(),color:"#ef4444"},
              {label:"EMA 20",value:lastBar?.ema20?.toLocaleString(),color:"#f59e0b"},
              {label:"EMA 60",value:lastBar?.ema60?.toLocaleString(),color:"#a78bfa"},
              {label:"RSI 일봉",value:lastRSI?.rsiD?.toFixed(1),color:lastRSI?.rsiD>=70?"#ef4444":lastRSI?.rsiD<=30?"#22c55e":"#94a3b8"},
              {label:"거래량",value:cur.volume?.toLocaleString(),color:"#38bdf8"},
            ].map(c=>(
              <div key={c.label} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:8,padding:"8px 12px"}}>
                <div style={{fontSize:10,color:"#475569",marginBottom:3}}>{c.label}</div>
                {cur.loading?<Skel w={50} h={14}/>:<div style={{fontSize:13,fontWeight:700,color:c.color}}>{c.value??'—'}</div>}
              </div>
            ))}
          </div>

          {/* 차트 컨트롤 */}
          <div style={{display:"flex",gap:8,marginBottom:10,flexWrap:"wrap",alignItems:"center"}}>
            {/* 차트 타입 */}
            {[["price","가격 + EMA"],["rsi","RSI"]].map(([t,label])=>(
              <button key={t} onClick={()=>setChartType(t)} style={{padding:"5px 14px",borderRadius:6,fontSize:12,fontWeight:600,
                background:chartType===t?"#1e293b":"transparent",
                border:chartType===t?"1px solid #38bdf8":"1px solid #1e293b",
                color:chartType===t?"#38bdf8":"#64748b"}}>
                {label}
              </button>
            ))}

            {/* 일봉/주봉/월봉 버튼 — 가격+EMA 탭에서만 표시 */}
            {chartType==="price" && (
              <div style={{display:"flex",gap:4,marginLeft:8,background:"#0f172a",padding:3,borderRadius:7,border:"1px solid #1e293b"}}>
                {[["D","일봉"],["W","주봉"],["M","월봉"]].map(([u,label])=>(
                  <button key={u} onClick={()=>setChartUnit(u)} style={unitBtnStyle(u)}>
                    {label}
                  </button>
                ))}
              </div>
            )}

            <button onClick={()=>{fetchPrices();fetchChart(selected);}}
              style={{marginLeft:"auto",padding:"5px 12px",borderRadius:6,fontSize:12,fontWeight:600,background:"transparent",border:"1px solid #1e293b",color:"#64748b"}}>
              ⟳
            </button>
          </div>

          {/* 차트 */}
          <div style={{background:"#0a1020",border:"1px solid #1e293b",borderRadius:10,padding:"14px 4px",position:"relative"}}>
            {chartLoading&&(
              <div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"#0a1020cc",borderRadius:10,zIndex:10}}>
                <div style={{width:24,height:24,border:"2px solid #38bdf8",borderTopColor:"transparent",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}/>
              </div>
            )}

            {chartType==="price"?(
              <>
                <ResponsiveContainer width="100%" height={220}>
                  <LineChart data={display}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b"/>
                    <XAxis dataKey="date" tick={{fontSize:9,fill:"#475569"}} interval={Math.floor(display.length/6)}/>
                    <YAxis domain={["auto","auto"]} tick={{fontSize:9,fill:"#475569"}} width={62} tickFormatter={v=>v.toLocaleString()}/>
                    <Tooltip contentStyle={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:6,fontSize:11}}
                      formatter={(v,name)=>[v?.toLocaleString(),name==="close"?"종가":name==="ema20"?"EMA 20":"EMA 60"]}/>
                    <Line type="monotone" dataKey="close" stroke="#e2e8f0" dot={false} strokeWidth={1.5}/>
                    <Line type="monotone" dataKey="ema20" stroke="#f59e0b" dot={false} strokeWidth={1.5} strokeDasharray="4 2"/>
                    <Line type="monotone" dataKey="ema60" stroke="#a78bfa" dot={false} strokeWidth={1.5} strokeDasharray="4 2"/>
                  </LineChart>
                </ResponsiveContainer>
                <div style={{display:"flex",gap:16,justifyContent:"center",marginTop:8}}>
                  {[["종가","#e2e8f0"],["EMA 20","#f59e0b"],["EMA 60","#a78bfa"]].map(([l,c])=>(
                    <div key={l} style={{display:"flex",alignItems:"center",gap:5,fontSize:10,color:"#64748b"}}>
                      <div style={{width:16,height:2,background:c}}/>{l}
                    </div>
                  ))}
                </div>

                {/* EMA 해석 가이드 */}
                {(()=>{
                  const ema20 = lastBar?.ema20;
                  const ema60 = lastBar?.ema60;
                  const price = cur.price;
                  if(!ema20||!ema60||!price) return null;

                  const cross = ema20>ema60 ? "golden" : "dead";

                  // 가격 위치 판단
                  let position, posColor, posDesc;
                  if(price>ema20&&ema20>ema60){
                    position="강한 상승 추세"; posColor="#22c55e";
                    posDesc="가격 > EMA20 > EMA60 — 추세가 탄탄하게 유지되고 있어요.";
                  } else if(ema20>price&&price>ema60){
                    position="조정 중 (중기 추세 유지)"; posColor="#f59e0b";
                    posDesc="EMA20 > 가격 > EMA60 — 단기 조정이지만 중기 상승 추세는 살아있어요.";
                  } else if(ema20>ema60&&ema60>price){
                    position="단기 과매도 (반등 가능)"; posColor="#38bdf8";
                    posDesc="EMA20 > EMA60 > 가격 — 추세는 상승이지만 가격이 너무 내려왔어요. 반등 가능성 있어요.";
                  } else if(price<ema20&&ema20<ema60){
                    position="강한 하락 추세"; posColor="#ef4444";
                    posDesc="가격 < EMA20 < EMA60 — 추세가 하락으로 정렬돼 있어요. 신중하게 접근하세요.";
                  } else {
                    position="추세 전환 구간"; posColor="#94a3b8";
                    posDesc="EMA와 가격이 혼재 — 방향성이 불명확한 구간이에요. 관망을 권장해요.";
                  }

                  // EMA 간격 판단
                  const gap = Math.abs(ema20-ema60)/ema60*100;
                  let gapDesc;
                  if(gap>3) gapDesc="두 선의 간격이 넓어요 → 현재 추세가 강하게 유지되고 있어요.";
                  else if(gap>1) gapDesc="두 선의 간격이 좁아지고 있어요 → 추세 전환(크로스) 가능성을 주시하세요.";
                  else gapDesc="두 선이 거의 붙어있어요 → 크로스 임박! 방향 전환 신호에 주목하세요.";

                  return (
                    <div style={{marginTop:12,padding:"12px 14px",background:"#0b1628",border:"1px solid #1e293b",borderRadius:8,fontSize:11,lineHeight:2}}>
                      <div style={{color:"#94a3b8",fontWeight:700,marginBottom:6,fontSize:12}}>📊 EMA 신호 분석</div>

                      {/* 크로스 상태 */}
                      <div style={{marginBottom:4}}>
                        <span style={{color: cross==="golden"?"#34d399":"#f87171", fontWeight:700}}>
                          {cross==="golden"?"▲ 골든크로스":"▼ 데드크로스"}
                        </span>
                        <span style={{color:"#64748b",marginLeft:8}}>
                          {cross==="golden"
                            ? "EMA20 > EMA60 — 단기 평균이 중기를 넘어선 상승 신호"
                            : "EMA20 < EMA60 — 단기 평균이 중기 아래로 꺾인 하락 신호"}
                        </span>
                      </div>

                      {/* 가격 위치 */}
                      <div style={{marginBottom:4}}>
                        <span style={{color:posColor,fontWeight:700}}>{position}</span>
                        <span style={{color:"#64748b",marginLeft:8}}>{posDesc}</span>
                      </div>

                      {/* 간격 분석 */}
                      <div>
                        <span style={{color:"#475569"}}>간격 {gap.toFixed(1)}%</span>
                        <span style={{color:"#64748b",marginLeft:8}}>{gapDesc}</span>
                      </div>
                    </div>
                  );
                })()}

                {/* 단위별 EMA 가이드 */}
                <div style={{marginTop:10,padding:"12px 14px",background:"#080c14",border:"1px solid #1e293b",borderRadius:8,fontSize:11,lineHeight:2,color:"#475569"}}>
                  <div style={{color:"#64748b",fontWeight:700,marginBottom:6}}>
                    📖 EMA 읽는 법 ({chartUnit==="D"?"일봉":chartUnit==="W"?"주봉":"월봉"} 기준)
                  </div>

                  {/* 공통: 골든/데드크로스 */}
                  <div style={{marginBottom:6}}>
                    <span style={{color:"#94a3b8",fontWeight:600}}>① 골든/데드크로스</span><br/>
                    <span style={{color:"#34d399"}}>▲ 골든크로스</span> — EMA20이 EMA60을 아래→위 돌파 · 상승 추세 전환 신호<br/>
                    <span style={{color:"#f87171"}}>▼ 데드크로스</span> — EMA20이 EMA60을 위→아래 돌파 · 하락 추세 전환 신호
                  </div>

                  {/* 공통: 가격 위치 */}
                  <div style={{marginBottom:6}}>
                    <span style={{color:"#94a3b8",fontWeight:600}}>② 가격 위치로 추세 판단</span><br/>
                    <span style={{color:"#22c55e"}}>가격 &gt; EMA20 &gt; EMA60</span> → 강한 상승 추세<br/>
                    <span style={{color:"#f59e0b"}}>EMA20 &gt; 가격 &gt; EMA60</span> → 조정 중, 중기 추세 유지<br/>
                    <span style={{color:"#38bdf8"}}>EMA20 &gt; EMA60 &gt; 가격</span> → 단기 과매도, 반등 가능성<br/>
                    <span style={{color:"#ef4444"}}>가격 &lt; EMA20 &lt; EMA60</span> → 강한 하락 추세
                  </div>

                  {/* 단위별 해석 */}
                  {chartUnit==="D" && (
                    <div style={{marginBottom:6}}>
                      <span style={{color:"#94a3b8",fontWeight:600}}>③ 일봉 EMA 특징</span><br/>
                      하루하루 노이즈가 많아 속임수 신호가 생길 수 있어요.<br/>
                      일봉 골든크로스만으로 판단하면 위험 — 주봉/월봉도 함께 확인하세요.<br/>
                      단기 트레이딩(수일~수주) 타이밍 포착에 유용해요.
                    </div>
                  )}
                  {chartUnit==="W" && (
                    <div style={{marginBottom:6}}>
                      <span style={{color:"#94a3b8",fontWeight:600}}>③ 주봉 EMA 특징</span><br/>
                      5일치를 압축해 일봉보다 신뢰도가 훨씬 높아요.<br/>
                      주봉 EMA20이 우상향 중이라면 일봉 하락은 단기 조정일 가능성이 높아요.<br/>
                      주봉 데드크로스 → 수주~수개월 단위 하락 추세 진입 신호로 봐요.
                    </div>
                  )}
                  {chartUnit==="M" && (
                    <div style={{marginBottom:6}}>
                      <span style={{color:"#94a3b8",fontWeight:600}}>③ 월봉 EMA 특징</span><br/>
                      장기 투자자의 관점 — 단기 등락에 전혀 흔들리지 않아요.<br/>
                      월봉 골든크로스 → 수년 단위 장기 상승 사이클 진입 신호<br/>
                      월봉 데드크로스 → 2008년 금융위기, 2022년 하락장 같은 구조적 하락의 신호였어요.
                    </div>
                  )}

                  {/* 공통: 세 시간대 종합 판단 */}
                  <div>
                    <span style={{color:"#94a3b8",fontWeight:600}}>④ 세 시간대 종합 판단</span><br/>
                    일봉만 골든크로스 → 단기 반등, 신중하게<br/>
                    일봉 + 주봉 골든크로스 → 신뢰도 높은 상승 신호<br/>
                    일봉 + 주봉 + 월봉 모두 골든크로스 → 강한 장기 상승 추세<br/>
                    <span style={{color:"#f87171"}}>월봉 데드크로스 + 일봉 골든크로스</span> → 하락 추세 속 단기 반등, 매우 주의
                  </div>
                </div>
              </>
            ):(
              <>
                {/* RSI 차트 — 일봉/주봉/월봉 한 그래프 */}
                <div style={{fontSize:11,color:"#475569",padding:"0 8px 8px",fontWeight:600}}>
                  RSI (14) · 일봉 + 주봉 + 월봉
                </div>
                <ResponsiveContainer width="100%" height={240}>
                  <LineChart data={displayRSI}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b"/>
                    <XAxis dataKey="date" tick={{fontSize:9,fill:"#475569"}} interval={Math.floor(displayRSI.length/6)}/>
                    <YAxis domain={[0,100]} tick={{fontSize:9,fill:"#475569"}} width={32}/>
                    <Tooltip
                      contentStyle={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:6,fontSize:11}}
                      formatter={(v,name)=>{
                        if(v==null) return null;
                        const label = name==="rsiD"?"일봉 RSI":name==="rsiW"?"주봉 RSI":"월봉 RSI";
                        return [v.toFixed(1), label];
                      }}
                    />
                    <ReferenceLine y={70} stroke="#ef4444" strokeDasharray="4 2"
                      label={{value:"과매수(70)",fill:"#ef4444",fontSize:9,position:"insideTopLeft"}}/>
                    <ReferenceLine y={50} stroke="#475569" strokeDasharray="2 4"/>
                    <ReferenceLine y={30} stroke="#22c55e" strokeDasharray="4 2"
                      label={{value:"과매도(30)",fill:"#22c55e",fontSize:9,position:"insideBottomLeft"}}/>
                    <Line type="monotone" dataKey="rsiD" stroke="#38bdf8" dot={false} strokeWidth={1.5} connectNulls={false}/>
                    <Line type="monotone" dataKey="rsiW" stroke="#f59e0b" dot={false} strokeWidth={2} connectNulls={false}/>
                    <Line type="monotone" dataKey="rsiM" stroke="#a78bfa" dot={false} strokeWidth={2.5} connectNulls={false}/>
                  </LineChart>
                </ResponsiveContainer>
                <div style={{display:"flex",gap:16,justifyContent:"center",marginTop:8}}>
                  {[["일봉 RSI","#38bdf8"],["주봉 RSI","#f59e0b"],["월봉 RSI","#a78bfa"]].map(([l,c])=>(
                    <div key={l} style={{display:"flex",alignItems:"center",gap:5,fontSize:10,color:"#64748b"}}>
                      <div style={{width:16,height:2,background:c}}/>{l}
                    </div>
                  ))}
                </div>
                <div style={{marginTop:8,padding:"8px 12px",background:"#0f172a",borderRadius:8,fontSize:11,color:"#64748b",lineHeight:1.8}}>
                  <span style={{color:"#ef4444"}}>● ≥70 과매수</span> &nbsp;
                  <span style={{color:"#22c55e"}}>● ≤30 과매도</span> &nbsp;
                  <span style={{color:"#94a3b8"}}>● 30~70 중립</span>
                </div>

                {/* RSI 자동 분석 */}
                {(()=>{
                  const d = lastRSI?.rsiD;
                  const w = lastRSI?.rsiW;
                  const m = lastRSI?.rsiM;
                  if(d==null) return null;

                  const rsiLabel = (v) => {
                    if(v==null) return { text:"데이터 없음", color:"#475569" };
                    if(v>=70)   return { text:`${v.toFixed(1)} 과매수`, color:"#ef4444" };
                    if(v<=30)   return { text:`${v.toFixed(1)} 과매도`, color:"#22c55e" };
                    return { text:`${v.toFixed(1)} 중립`, color:"#94a3b8" };
                  };

                  // 세 시간대 종합 신호
                  let signal, sigColor;
                  const overBought = [d>=70, w>=70, m>=70].filter(Boolean).length;
                  const overSold   = [d<=30, w<=30, m<=30].filter(Boolean).length;
                  if(overBought>=2){
                    signal="⚠️ 과매수 구간 — 단기 조정 가능성이 높아요. 신규 매수는 신중하게.";
                    sigColor="#ef4444";
                  } else if(overSold>=2){
                    signal="✅ 과매도 구간 — 반등 가능성이 높아요. 분할 매수 고려해볼 만해요.";
                    sigColor="#22c55e";
                  } else if(d>=70&&w<70){
                    signal="📌 일봉 과매수지만 주봉은 중립 — 단기 과열, 조정 후 재진입 고려.";
                    sigColor="#f59e0b";
                  } else if(d<=30&&w>30){
                    signal="📌 일봉 과매도지만 주봉은 중립 — 단기 급락, 반등 여부 주봉으로 확인하세요.";
                    sigColor="#38bdf8";
                  } else if(d>50&&w>50&&m>50){
                    signal="📈 일봉·주봉·월봉 모두 50 이상 — 전반적인 상승 모멘텀이 살아있어요.";
                    sigColor="#34d399";
                  } else if(d<50&&w<50&&m<50){
                    signal="📉 일봉·주봉·월봉 모두 50 이하 — 전반적인 하락 모멘텀이 지속되고 있어요.";
                    sigColor="#f87171";
                  } else {
                    signal="➖ 뚜렷한 방향성 없음 — 추세 확인 후 판단하세요.";
                    sigColor="#64748b";
                  }

                  const dLabel = rsiLabel(d);
                  const wLabel = rsiLabel(w);
                  const mLabel = rsiLabel(m);

                  return (
                    <div style={{marginTop:12,padding:"12px 14px",background:"#0b1628",border:"1px solid #1e293b",borderRadius:8,fontSize:11,lineHeight:2}}>
                      <div style={{color:"#94a3b8",fontWeight:700,marginBottom:6,fontSize:12}}>📊 RSI 신호 분석</div>

                      {/* 세 시간대 값 */}
                      <div style={{display:"flex",gap:20,marginBottom:8}}>
                        <div><span style={{color:"#38bdf8"}}>일봉</span> <span style={{color:dLabel.color,fontWeight:700}}>{dLabel.text}</span></div>
                        <div><span style={{color:"#f59e0b"}}>주봉</span> <span style={{color:wLabel.color,fontWeight:700}}>{wLabel.text}</span></div>
                        <div><span style={{color:"#a78bfa"}}>월봉</span> <span style={{color:mLabel.color,fontWeight:700}}>{mLabel.text}</span></div>
                      </div>

                      {/* 종합 신호 */}
                      <div style={{color:sigColor}}>{signal}</div>
                    </div>
                  );
                })()}

                {/* RSI 고정 가이드 */}
                <div style={{marginTop:10,padding:"12px 14px",background:"#080c14",border:"1px solid #1e293b",borderRadius:8,fontSize:11,lineHeight:2,color:"#475569"}}>
                  <div style={{color:"#64748b",fontWeight:700,marginBottom:6}}>📖 RSI 읽는 법 (기억용)</div>

                  <div style={{marginBottom:6}}>
                    <span style={{color:"#94a3b8",fontWeight:600}}>① RSI 기본 해석</span><br/>
                    <span style={{color:"#ef4444"}}>70 이상</span> → 과매수 · 단기 조정 가능성, 신규 매수 자제<br/>
                    <span style={{color:"#22c55e"}}>30 이하</span> → 과매도 · 반등 가능성, 분할 매수 고려<br/>
                    <span style={{color:"#94a3b8"}}>30~70</span> → 중립 · 추세 방향으로 추종
                  </div>

                  <div style={{marginBottom:6}}>
                    <span style={{color:"#94a3b8",fontWeight:600}}>② 50선의 의미</span><br/>
                    RSI 50 이상 유지 → 상승 모멘텀 · 50 이하 유지 → 하락 모멘텀<br/>
                    50선 돌파/이탈은 추세 전환의 초기 신호로 볼 수 있어요.
                  </div>

                  <div style={{marginBottom:6}}>
                    <span style={{color:"#94a3b8",fontWeight:600}}>③ 일봉/주봉/월봉 종합 판단</span><br/>
                    일봉만 과매수 → 단기 과열, 주봉 확인 필요<br/>
                    일봉+주봉 과매수 → 중기 과열, 조정 가능성 높음<br/>
                    세 시간대 모두 과매수 → 강한 조정 또는 하락 전환 경고<br/>
                    세 시간대 모두 과매도 → 강한 반등 가능성, 분할 매수 고려
                  </div>

                  <div>
                    <span style={{color:"#94a3b8",fontWeight:600}}>④ 주의사항</span><br/>
                    강한 추세장에서는 RSI가 70 이상에서 오래 머물 수 있어요.<br/>
                    RSI 단독보다 EMA 크로스와 함께 보면 신뢰도가 높아져요.
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
