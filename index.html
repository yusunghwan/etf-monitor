<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ETF Monitor" />
  <meta name="theme-color" content="#080c14" />
  <title>ETF Monitor</title>
  <link rel="apple-touch-icon" href="icon.png" />
  <link rel="manifest" href="manifest.json" />
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&display=swap');
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: #080c14; color: #e2e8f0; font-family: 'DM Mono', monospace; overflow: hidden; }
    #root { height: 100%; display: flex; flex-direction: column; }
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: #080c14; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
    @keyframes spin { to{transform:rotate(360deg)} }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .fade-in { animation: fadeIn 0.3s ease both; }
    button { font-family: inherit; cursor: pointer; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const WORKER_URL = "https://kis-proxy.yusunghwan.workers.dev";
const API = WORKER_URL;

// ═══════════════════════════════════════════════════════════════
//  ★ 종목 추가/변경 방법
//
//  아래 ETF_LIST 배열에 항목을 추가하거나 수정하세요.
//  ticker : KRX 종목코드 (6자리 숫자)
//  name   : 화면에 표시할 이름 (자유롭게 입력)
//
//  예시) { ticker: "102110", name: "TIGER 200" },
//       { ticker: "kodex레버리지", name: "KODEX 레버리지" },
//
//  주요 ETF 종목코드 참고:
//  069500  KODEX 200
//  102110  TIGER 200
//  360750  TIGER 미국S&P500
//  133690  TIGER 미국나스닥100
//  114800  KODEX 인버스
//  252670  KODEX 200선물인버스2X
//  229200  KODEX 코스닥150
//  132030  KODEX 골드선물
//  139660  TIGER 미국달러단기채권액티브
//  385560  TIGER 미국채10년선물
// ═══════════════════════════════════════════════════════════════
const ETF_LIST = [
  { ticker: "069500", name: "KODEX 200" },
  { ticker: "360750", name: "TIGER 미국S&P500" },
  { ticker: "133690", name: "TIGER 미국나스닥100" },
  { ticker: "114800", name: "KODEX 인버스" },
  { ticker: "229200", name: "KODEX 코스닥150" },
  { ticker: "132030", name: "KODEX 골드선물" },
];

// ── 지표 계산 ─────────────────────────────────────────────────────
const calcEMA = (data, p) => {
  const k = 2/(p+1); const res = []; let prev = null;
  data.forEach((v,i) => {
    if(i < p-1){res.push(null);return;}
    if(prev===null) prev = data.slice(0,p).reduce((s,x)=>s+x,0)/p;
    const cur = v*k+prev*(1-k); res.push(+cur.toFixed(2)); prev=cur;
  });
  return res;
};

const calcRSI = (closes, p=14) => {
  const res = Array(closes.length).fill(null);
  if(closes.length < p+1) return res;
  let g=0,l=0;
  for(let i=1;i<=p;i++){const d=closes[i]-closes[i-1]; if(d>0)g+=d; else l-=d;}
  let ag=g/p, al=l/p;
  res[p] = al===0?100:+(100-100/(1+ag/al)).toFixed(2);
  for(let i=p+1;i<closes.length;i++){
    const d=closes[i]-closes[i-1];
    ag=(ag*(p-1)+Math.max(d,0))/p; al=(al*(p-1)+Math.max(-d,0))/p;
    res[i] = al===0?100:+(100-100/(1+ag/al)).toFixed(2);
  }
  return res;
};

// 일봉/주봉/월봉 변환 (일봉 데이터를 집계)
const groupCandles = (candles, unit) => {
  if(unit === "D") return candles;
  const groups = {};
  candles.forEach(c => {
    let key;
    const d = c.rawDate; // YYYYMMDD
    if(unit === "W") {
      // 해당 날짜가 속한 주의 월요일 기준
      const date = new Date(d.slice(0,4), d.slice(4,6)-1, d.slice(6,8));
      const day = date.getDay();
      const diff = day===0 ? -6 : 1-day;
      date.setDate(date.getDate()+diff);
      key = date.toISOString().slice(0,10).replace(/-/g,"");
    } else {
      key = d.slice(0,6); // YYYYMM
    }
    if(!groups[key]) groups[key] = {rawDate:key, open:c.open, high:c.high, low:c.low, close:c.close, volume:c.volume};
    else {
      groups[key].high = Math.max(groups[key].high, c.high);
      groups[key].low  = Math.min(groups[key].low,  c.low);
      groups[key].close = c.close;
      groups[key].volume += c.volume;
    }
  });
  return Object.values(groups).sort((a,b)=>a.rawDate.localeCompare(b.rawDate));
};

const formatDate = (rawDate, unit) => {
  if(!rawDate) return "";
  const s = String(rawDate);
  if(unit === "D") return `${s.slice(4,6)}/${s.slice(6,8)}`;
  if(unit === "W") return `${s.slice(4,6)}/${s.slice(6,8)}`;
  return `${s.slice(0,4)}/${s.slice(4,6)}`;
};

const enrichChart = (candles, unit="D") => {
  const grouped = groupCandles(candles, unit);
  const closes = grouped.map(c=>c.close);
  const ema20=calcEMA(closes,20), ema60=calcEMA(closes,60), rsi=calcRSI(closes,14);
  return grouped.map((c,i)=>({
    ...c,
    date: formatDate(c.rawDate, unit),
    ema20:ema20[i], ema60:ema60[i], rsi:rsi[i],
  }));
};

// ── 컴포넌트 ──────────────────────────────────────────────────────
const { useState, useEffect, useRef, useCallback } = React;
const { LineChart,Line,XAxis,YAxis,CartesianGrid,Tooltip,ResponsiveContainer,ReferenceLine } = Recharts;

const Skel = ({w="100%",h=14}) => (
  <div style={{width:w,height:h,borderRadius:4,background:"#1e293b",animation:"pulse 1.5s infinite"}}/>
);

const RSIMeter = ({value}) => {
  if(value==null) return <span style={{color:"#475569",fontSize:11}}>—</span>;
  const color = value>=70?"#ef4444":value<=30?"#22c55e":"#94a3b8";
  const label = value>=70?"과매수":value<=30?"과매도":"중립";
  return (
    <div style={{width:"100%"}}>
      <div style={{display:"flex",justifyContent:"space-between",fontSize:10,marginBottom:3}}>
        <span style={{color,fontWeight:700}}>{value.toFixed(1)}</span>
        <span style={{color}}>{label}</span>
      </div>
      <div style={{height:4,borderRadius:4,background:"#1e293b",overflow:"hidden"}}>
        <div style={{height:"100%",width:`${value}%`,background:color,borderRadius:4,transition:"width 0.5s"}}/>
      </div>
    </div>
  );
};

const Signal = ({ema20,ema60}) => {
  if(!ema20||!ema60) return null;
  const bull = ema20>ema60;
  return <span style={{fontSize:11,padding:"2px 10px",borderRadius:20,fontWeight:700,background:bull?"#064e3b":"#450a0a",color:bull?"#34d399":"#f87171"}}>{bull?"▲ 골든크로스":"▼ 데드크로스"}</span>;
};

// ── 메인 앱 ──────────────────────────────────────────────────────
function App() {
  const [etfs,setEtfs]           = useState(ETF_LIST.map(e=>({...e,loading:true})));
  const [selected,setSelected]   = useState(ETF_LIST[0].ticker);
  const [rawCandles,setRawCandles] = useState([]); // 원본 일봉 데이터
  const [chartUnit,setChartUnit] = useState("D");  // D/W/M
  const [chartType,setChartType] = useState("price");
  const [chartLoading,setChartLoading] = useState(false);
  const [serverOk,setServerOk]   = useState(null);
  const [lastUpdate,setLastUpdate] = useState(null);
  const [sideOpen,setSideOpen]   = useState(true);
  const timerRef = useRef(null);

  useEffect(()=>{
    fetch(`${API}/api/health`).then(r=>r.ok?setServerOk(true):setServerOk(false)).catch(()=>setServerOk(false));
  },[]);

  const fetchPrices = useCallback(async()=>{
    const results = await Promise.allSettled(
      ETF_LIST.map(e=>fetch(`${API}/api/price/${e.ticker}`).then(r=>r.json()))
    );
    setEtfs(prev=>prev.map((e,i)=>{
      const r=results[i];
      if(r.status==="fulfilled"&&r.value.price) return{...e,...r.value, name:e.name, loading:false,error:false};
      return{...e,loading:false,error:true};
    }));
    setLastUpdate(new Date());
  },[]);

  const fetchChart = useCallback(async(ticker)=>{
    setChartLoading(true);
    try{
      const r=await fetch(`${API}/api/chart/${ticker}?period=300`);
      const d=await r.json();
      // rawDate 보존
      const candles = (d.candles||[]).map(c=>({...c, rawDate:c.date}));
      setRawCandles(candles);
    }catch{ setRawCandles([]); }
    finally{ setChartLoading(false); }
  },[]);

  useEffect(()=>{
    fetchPrices(); fetchChart(selected);
    timerRef.current=setInterval(fetchPrices,10000);
    return()=>clearInterval(timerRef.current);
  },[]);

  useEffect(()=>{ fetchChart(selected); },[selected]);

  const cur = etfs.find(e=>e.ticker===selected)??{};

  // 단위별 차트 데이터 계산
  const chartData = enrichChart(rawCandles, chartUnit);
  const display = chartData.slice(-60);
  const lastBar = chartData[chartData.length-1];

  const safeTop = "env(safe-area-inset-top, 0px)";
  const safeBottom = "env(safe-area-inset-bottom, 0px)";

  const unitBtnStyle = (u) => ({
    padding:"4px 12px", borderRadius:6, fontSize:11, fontWeight:600,
    background: chartUnit===u?"#1e3a5f":"transparent",
    border: chartUnit===u?"1px solid #38bdf8":"1px solid #1e293b",
    color: chartUnit===u?"#38bdf8":"#64748b",
  });

  return (
    <div style={{display:"flex",flexDirection:"column",height:"100%",paddingTop:safeTop,paddingBottom:safeBottom}}>

      {/* 헤더 */}
      <div style={{borderBottom:"1px solid #1e293b",padding:"12px 20px",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <button onClick={()=>setSideOpen(o=>!o)} style={{background:"none",border:"none",color:"#64748b",fontSize:18,padding:"0 4px",lineHeight:1}}>☰</button>
          <div style={{width:8,height:8,borderRadius:"50%",background:serverOk===null?"#f59e0b":serverOk?"#22c55e":"#ef4444",boxShadow:`0 0 8px ${serverOk?"#22c55e":"#ef4444"}`,animation:"pulse 2s infinite"}}/>
          <span style={{fontSize:15,fontWeight:700,letterSpacing:"0.1em"}}>ETF MONITOR</span>
          <span style={{fontSize:10,padding:"2px 8px",borderRadius:4,background:serverOk?"#064e3b":"#450a0a",color:serverOk?"#34d399":"#f87171"}}>
            {serverOk===null?"연결 중…":serverOk?"KIS 연결됨":"오프라인"}
          </span>
        </div>
        <div style={{fontSize:11,color:"#475569"}}>
          {lastUpdate?lastUpdate.toLocaleTimeString("ko-KR"):"—"}
        </div>
      </div>

      <div style={{display:"flex",flex:1,overflow:"hidden"}}>

        {/* ── 사이드바 ── */}
        {sideOpen && (
          <div style={{width:220,borderRight:"1px solid #1e293b",overflowY:"auto",flexShrink:0}} className="fade-in">
            {etfs.map(e=>(
              <div key={e.ticker} onClick={()=>setSelected(e.ticker)}
                style={{padding:"12px 14px",cursor:"pointer",
                  borderLeft:selected===e.ticker?"2px solid #38bdf8":"2px solid transparent",
                  background:selected===e.ticker?"#0f172a":"transparent",transition:"all 0.15s"}}>

                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div style={{flex:1,minWidth:0,marginRight:8}}>
                    {/* ★ 1번 수정: 종목명 크게, 코드 작게 */}
                    <div style={{fontWeight:700,fontSize:13,color:selected===e.ticker?"#38bdf8":"#f1f5f9",
                      whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>
                      {e.name}
                    </div>
                    <div style={{fontSize:10,color:"#475569",marginTop:2}}>{e.ticker}</div>
                  </div>
                  <div style={{textAlign:"right",flexShrink:0}}>
                    {e.loading?<Skel w={55} h={12}/>:<>
                      <div style={{fontWeight:700,fontSize:12}}>{e.price?.toLocaleString()??'—'}</div>
                      <div style={{fontSize:11,color:(e.change_pct??0)>=0?"#22c55e":"#ef4444"}}>
                        {(e.change_pct??0)>=0?"+":""}{e.change_pct?.toFixed(2)??"—"}%
                      </div>
                    </>}
                  </div>
                </div>

                {selected===e.ticker&&lastBar?.rsi!=null&&(
                  <div style={{marginTop:8}}><RSIMeter value={lastBar.rsi}/></div>
                )}
              </div>
            ))}
          </div>
        )}

        {/* ── 메인 패널 ── */}
        <div style={{flex:1,overflowY:"auto",padding:20}} className="fade-in">

          {/* 종목 헤더 */}
          <div style={{marginBottom:16}}>
            <div style={{display:"flex",alignItems:"baseline",gap:10,flexWrap:"wrap"}}>
              <span style={{fontSize:20,fontWeight:800,color:"#f8fafc"}}>{cur.name}</span>
              <span style={{fontSize:11,color:"#64748b"}}>{cur.ticker}</span>
              {lastBar&&<Signal ema20={lastBar.ema20} ema60={lastBar.ema60}/>}
            </div>
            <div style={{marginTop:6,fontSize:26,fontWeight:700}}>
              {cur.loading?<Skel w={150} h={26}/>:<>
                {cur.price?.toLocaleString()??'—'}원
                <span style={{fontSize:14,marginLeft:10,color:(cur.change_pct??0)>=0?"#22c55e":"#ef4444"}}>
                  {(cur.change_pct??0)>=0?"+":""}{cur.change?.toLocaleString()??'—'} ({(cur.change_pct??0)>=0?"+":""}{cur.change_pct?.toFixed(2)??"—"}%)
                </span>
              </>}
            </div>
          </div>

          {/* 지표 카드 */}
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8,marginBottom:16}}>
            {[
              {label:"고가",value:cur.high?.toLocaleString(),color:"#22c55e"},
              {label:"저가",value:cur.low?.toLocaleString(),color:"#ef4444"},
              {label:"EMA 20",value:lastBar?.ema20?.toLocaleString(),color:"#f59e0b"},
              {label:"EMA 60",value:lastBar?.ema60?.toLocaleString(),color:"#a78bfa"},
              {label:`RSI (${chartUnit==="D"?"일봉":chartUnit==="W"?"주봉":"월봉"})`,value:lastBar?.rsi?.toFixed(1),color:lastBar?.rsi>=70?"#ef4444":lastBar?.rsi<=30?"#22c55e":"#94a3b8"},
              {label:"거래량",value:cur.volume?.toLocaleString(),color:"#38bdf8"},
            ].map(c=>(
              <div key={c.label} style={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:8,padding:"8px 12px"}}>
                <div style={{fontSize:10,color:"#475569",marginBottom:3}}>{c.label}</div>
                {cur.loading?<Skel w={50} h={14}/>:<div style={{fontSize:13,fontWeight:700,color:c.color}}>{c.value??'—'}</div>}
              </div>
            ))}
          </div>

          {/* 차트 컨트롤 */}
          <div style={{display:"flex",gap:8,marginBottom:10,flexWrap:"wrap",alignItems:"center"}}>
            {/* 차트 타입 */}
            {[["price","가격 + EMA"],["rsi","RSI"]].map(([t,label])=>(
              <button key={t} onClick={()=>setChartType(t)} style={{padding:"5px 14px",borderRadius:6,fontSize:12,fontWeight:600,
                background:chartType===t?"#1e293b":"transparent",
                border:chartType===t?"1px solid #38bdf8":"1px solid #1e293b",
                color:chartType===t?"#38bdf8":"#64748b"}}>
                {label}
              </button>
            ))}

            {/* ★ 3번 수정: 일봉/주봉/월봉 전환 버튼 */}
            <div style={{display:"flex",gap:4,marginLeft:8,background:"#0f172a",padding:3,borderRadius:7,border:"1px solid #1e293b"}}>
              {[["D","일봉"],["W","주봉"],["M","월봉"]].map(([u,label])=>(
                <button key={u} onClick={()=>setChartUnit(u)} style={unitBtnStyle(u)}>
                  {label}
                </button>
              ))}
            </div>

            <button onClick={()=>{fetchPrices();fetchChart(selected);}}
              style={{marginLeft:"auto",padding:"5px 12px",borderRadius:6,fontSize:12,fontWeight:600,background:"transparent",border:"1px solid #1e293b",color:"#64748b"}}>
              ⟳
            </button>
          </div>

          {/* 차트 */}
          <div style={{background:"#0a1020",border:"1px solid #1e293b",borderRadius:10,padding:"14px 4px",position:"relative"}}>
            {chartLoading&&(
              <div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"#0a1020cc",borderRadius:10,zIndex:10}}>
                <div style={{width:24,height:24,border:"2px solid #38bdf8",borderTopColor:"transparent",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}/>
              </div>
            )}

            {chartType==="price"?(
              <>
                <ResponsiveContainer width="100%" height={220}>
                  <LineChart data={display}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b"/>
                    <XAxis dataKey="date" tick={{fontSize:9,fill:"#475569"}} interval={Math.floor(display.length/6)}/>
                    <YAxis domain={["auto","auto"]} tick={{fontSize:9,fill:"#475569"}} width={62} tickFormatter={v=>v.toLocaleString()}/>
                    <Tooltip contentStyle={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:6,fontSize:11}}
                      formatter={(v,name)=>[v?.toLocaleString(),name==="close"?"종가":name==="ema20"?"EMA 20":"EMA 60"]}/>
                    <Line type="monotone" dataKey="close" stroke="#e2e8f0" dot={false} strokeWidth={1.5}/>
                    <Line type="monotone" dataKey="ema20" stroke="#f59e0b" dot={false} strokeWidth={1.5} strokeDasharray="4 2"/>
                    <Line type="monotone" dataKey="ema60" stroke="#a78bfa" dot={false} strokeWidth={1.5} strokeDasharray="4 2"/>
                  </LineChart>
                </ResponsiveContainer>
                <div style={{display:"flex",gap:16,justifyContent:"center",marginTop:8}}>
                  {[["종가","#e2e8f0"],["EMA 20","#f59e0b"],["EMA 60","#a78bfa"]].map(([l,c])=>(
                    <div key={l} style={{display:"flex",alignItems:"center",gap:5,fontSize:10,color:"#64748b"}}>
                      <div style={{width:16,height:2,background:c}}/>{l}
                    </div>
                  ))}
                </div>
              </>
            ):(
              <>
                {/* RSI 차트 — 일봉/주봉/월봉 모두 표시 */}
                <div style={{fontSize:11,color:"#475569",padding:"0 8px 8px",fontWeight:600}}>
                  RSI · {chartUnit==="D"?"일봉":""}
                  {chartUnit==="W"?"주봉":""}
                  {chartUnit==="M"?"월봉":""}
                  &nbsp;기준 (14)
                </div>
                <ResponsiveContainer width="100%" height={220}>
                  <LineChart data={display}>
                    <CartesianGrid strokeDasharray="3 3" stroke="#1e293b"/>
                    <XAxis dataKey="date" tick={{fontSize:9,fill:"#475569"}} interval={Math.floor(display.length/6)}/>
                    <YAxis domain={[0,100]} tick={{fontSize:9,fill:"#475569"}} width={32}/>
                    <Tooltip contentStyle={{background:"#0f172a",border:"1px solid #1e293b",borderRadius:6,fontSize:11}}
                      formatter={v=>[v?.toFixed(1),"RSI"]}/>
                    <ReferenceLine y={70} stroke="#ef4444" strokeDasharray="4 2"
                      label={{value:"과매수(70)",fill:"#ef4444",fontSize:9,position:"insideTopLeft"}}/>
                    <ReferenceLine y={50} stroke="#475569" strokeDasharray="2 4"/>
                    <ReferenceLine y={30} stroke="#22c55e" strokeDasharray="4 2"
                      label={{value:"과매도(30)",fill:"#22c55e",fontSize:9,position:"insideBottomLeft"}}/>
                    <Line type="monotone" dataKey="rsi" stroke="#38bdf8" dot={false} strokeWidth={2} connectNulls={false}/>
                  </LineChart>
                </ResponsiveContainer>
                <div style={{marginTop:10,padding:"8px 12px",background:"#0f172a",borderRadius:8,fontSize:11,color:"#64748b",lineHeight:1.8}}>
                  <span style={{color:"#ef4444"}}>● ≥70 과매수</span> &nbsp;
                  <span style={{color:"#22c55e"}}>● ≤30 과매도</span> &nbsp;
                  <span style={{color:"#94a3b8"}}>● 30~70 중립</span>
                </div>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
